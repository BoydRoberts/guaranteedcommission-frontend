<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agent Listing Preview</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .thumb { width: 100%; height: 160px; object-fit: cover; border-radius: 0.5rem; border: 1px solid #e5e7eb; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-5xl mx-auto px-4 py-8">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">Agent Listing Preview</h1>
      <button onclick="window.location.href='/agent-detail.html'" class="text-sm px-4 py-2 rounded border">Back to Edit</button>
    </div>

    <div id="content" class="bg-white rounded shadow p-5">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 space-y-4">
          <div id="primaryWrap" class="rounded overflow-hidden border">
            <img id="primaryImg" class="w-full h-80 object-cover" alt="Primary Photo" />
          </div>
          <div>
            <h2 class="text-xl font-semibold" id="addr"></h2>
            <p class="text-gray-700 mt-1">
              <span id="price"></span> • <span id="beds"></span> bd • <span id="baths"></span> ba • <span id="sqft"></span> sqft
            </p>
          </div>
          <div id="descBlock" class="mt-2">
            <h3 class="font-semibold mb-1">Description</h3>
            <p id="description" class="whitespace-pre-line text-gray-800"></p>
          </div>

          <div id="galleryBlock" class="mt-4">
            <h3 class="font-semibold mb-2">Photos</h3>
            <div id="gallery" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>
          </div>
        </div>

        <aside class="space-y-4">
          <div class="border rounded p-4 bg-gray-50">
            <h4 class="font-semibold mb-2">Commission</h4>
            <p><strong>Offer:</strong> <span id="commissionOffer"></span></p>
            <p><strong>Calculated:</strong> <span id="commissionCalc"></span></p>
          </div>
          <div class="border rounded p-4">
            <button onclick="window.print()" class="w-full bg-blue-600 text-white py-2 rounded">Print Preview</button>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <script>
    const selectedPlan = localStorage.getItem("selectedPlan") || "Listed Property Basic";
    const data = JSON.parse(localStorage.getItem("formData") || "{}");

    // Address + basics
    document.getElementById("addr").textContent = data.address || "[address]";
    document.getElementById("price").textContent = data.price ? Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' }).format(+data.price) : "—";
    document.getElementById("beds").textContent = data.beds || "—";
    document.getElementById("baths").textContent = data.baths || "—";
    document.getElementById("sqft").textContent = data.sqft || "—";

    // Description (hidden on Basic if none)
    const desc = data.description || "";
    if (!desc) {
      document.getElementById("descBlock").classList.add("hidden");
    } else {
      document.getElementById("description").textContent = desc;
    }

    // Primary photo
    const primaryImg = document.getElementById("primaryImg");
    if (data.primaryPhotoData) {
      primaryImg.src = data.primaryPhotoData;
    } else {
      primaryImg.src = "data:image/svg+xml;charset=UTF-8," + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="400"><rect width="100%" height="100%" fill="#e5e7eb"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#6b7280" font-size="20">No Primary Photo</text></svg>');
    }

    // Gallery (Plus/FSBO only)
    const galleryBlock = document.getElementById("galleryBlock");
    const gallery = document.getElementById("gallery");
    const photos = data.photosData || [];
    if (!photos.length || selectedPlan === "Listed Property Basic") {
      galleryBlock.classList.add("hidden");
    } else {
      photos.slice(0,20).forEach(src => {
        const img = document.createElement("img");
        img.src = src;
        img.className = "thumb";
        gallery.appendChild(img);
      });
    }

    // Commission
    const offer = (data.commissionType || "%") === "$"
      ? `$${data.commission || 0}`
      : `${data.commission || 0}%`;
    document.getElementById("commissionOffer").textContent = offer;

    const priceVal = parseFloat(data.price || "0");
    let calc = 0;
    if ((data.commissionType || "%") === "%") {
      calc = priceVal * ((parseFloat(data.commission || "0") || 0) / 100);
    } else {
      calc = parseFloat(data.commission || "0") || 0;
    }
    document.getElementById("commissionCalc").textContent =
      calc.toLocaleString(undefined, { style: 'currency', currency: 'USD' });
  </script>
</body>
</html>
