<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Review Cart and Checkout</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">

  <div class="max-w-xl mx-auto mt-10 bg-white p-6 rounded shadow">
    <h1 class="text-2xl font-bold text-center mb-6">Review Cart and Checkout</h1>

    <div class="space-y-4 text-sm">
      <p><strong>Selected Plan:</strong> <span id="selectedPlan">Loading...</span> - $<span id="planCost">0</span></p>

      <div>
        <strong>Upgrades:</strong>
        <div class="ml-4 space-y-2">
          <label class="flex items-center">
            <input type="checkbox" id="upgradeBanner" class="mr-2">
            Banner ($10)
          </label>
          <label class="flex items-center">
            <input type="checkbox" id="upgradePin" class="mr-2">
            Pin Placement ($50)
          </label>
        </div>
      </div>

      <p><strong>Total:</strong> $<span id="totalCost">0</span></p>
    </div>

    <button id="proceedPaymentBtn" class="w-full bg-green-600 text-white py-2 rounded mt-6">
      Proceed to Payment
    </button>
  </div>

  <script>
    const selectedPlan = localStorage.getItem("selectedPlan") || "Listed Property Basic";
    const originalPlan = selectedPlan;
    localStorage.setItem("activePlan", selectedPlan);

    let baseCost = {
      "Listed Property Basic": 0,
      "Listed Property Plus": 20,
      "FSBO Plus": 100
    }[selectedPlan] || 0;

    document.getElementById("selectedPlan").textContent = selectedPlan;
    document.getElementById("planCost").textContent = baseCost;

    const bannerCheckbox = document.getElementById("upgradeBanner");
    const pinCheckbox = document.getElementById("upgradePin");

    function calculateTotal() {
      let total = baseCost;
      if (bannerCheckbox.checked) total += 10;
      if (pinCheckbox.checked) total += 50;
      document.getElementById("totalCost").textContent = total;
    }

    bannerCheckbox.addEventListener("change", calculateTotal);
    pinCheckbox.addEventListener("change", calculateTotal);

    document.getElementById("proceedPaymentBtn").addEventListener("click", () => {
      let finalPlan = originalPlan;
      let planCost = baseCost;

      const upgrades = [];
      if (bannerCheckbox.checked) upgrades.push("Banner");
      if (pinCheckbox.checked) upgrades.push("Pin Placement");

      // Upgrade to Plus if Basic + any upgrade
      if (originalPlan === "Listed Property Basic" && upgrades.length > 0) {
        finalPlan = "Listed Property Plus";
        planCost = 20;
        localStorage.setItem("selectedPlan", finalPlan);
        localStorage.setItem("activePlan", finalPlan);
      }

      const total = planCost + (bannerCheckbox.checked ? 10 : 0) + (pinCheckbox.checked ? 50 : 0);
      document.getElementById("selectedPlan").textContent = finalPlan;
      document.getElementById("planCost").textContent = planCost;
      document.getElementById("totalCost").textContent = total;

      // Save full checkout data
      const checkoutData = {
        plan: finalPlan,
        planCost: planCost,
        upgrades: upgrades,
        totalCost: total
      };
      localStorage.setItem("checkoutData", JSON.stringify(checkoutData));
      localStorage.setItem("postSignatureOptions", finalPlan.includes("FSBO") ? "fsbo" : "listed");

      // Save short address for agent prompt
      const formData = JSON.parse(localStorage.getItem("formData") || "{}");
      if (formData.address) {
        const short = formData.address.split(',')[0];
        localStorage.setItem("shortAddress", short);
      }

      // Agent login intent
      const loginIntent = localStorage.getItem("loginIntent");
      if (loginIntent === "agent-complete-listing") {
        const short = localStorage.getItem("shortAddress");
        if (short) localStorage.setItem("agentPromptMsg", `Would you like to complete the listing detail page for ${short}?`);
      }

      // Redirect to next step
      window.location.href = "/signature.html";
    });

    calculateTotal();
  </script>

</body>
</html>
